name: CI/CD Pipeline

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: ‚òï Configurar Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üß™ Build com Maven
        run: mvn clean install -DskipTests

      - name: üì¶ Obter vers√£o do projeto (pom.xml)
        id: project_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: üê≥ Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build da imagem Docker
        run: docker build -t torresbento/bmt-servico-de-login:${{ steps.project_version.outputs.version }} .

      - name: üì§ Push para Docker Hub
        run: docker push torresbento/bmt-servico-de-login:${{ steps.project_version.outputs.version }}

      - name: üöÄ Verificar segredo REMOTE_HOST
        id: check_remote_host
        run: |
          if [ -z "${{ secrets.REMOTE_HOST }}" ]; then
            echo "ERROR: REMOTE_HOST not set!"
            exit 1
          else
            echo "REMOTE_HOST is set to ${REMOTE_HOST}"
          fi

      - name: üöÄ Deploy no servidor via SSH
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.REMOTE_PORT }}  # se n√£o for 22, sen√£o pode remover
          script: |
            echo "‚õî Parando container antigo (se existir)..."
            sudo docker stop servico-de-login || true

            echo "üóëÔ∏è Removendo container antigo (se existir)..."
            sudo docker rm servico-de-login || true

            echo "üßπ Removendo imagem antiga (se existir)..."
            sudo docker image prune -a -f --filter "label=project=servico-de-login" || true

            echo "‚¨áÔ∏è Baixando nova imagem..."
            sudo docker pull torresbento/bmt-servico-de-login:${{ steps.project_version.outputs.version }}

            echo "üåê Garantindo que a rede Docker personalizada exista com o subnet correto..."
            # Verificando se a rede bmt-rede-docker existe e se tem o subnet correto
            if sudo docker network inspect bmt-rede-docker > /dev/null 2>&1; then
              # Se a rede j√° existir, verifique o subnet
              echo "Rede bmt-rede-docker j√° existe. Verificando subnet..."
              if ! sudo docker network inspect tbmt-rede-docker | grep -q '"Subnet": "172.18.0.0/16"'; then
                echo "A rede bmt-rede-docker n√£o tem o subnet correto. Removendo e recriando..."
                sudo docker network rm bmt-rede-docker || true
                sudo docker network create --driver bridge --subnet 172.18.0.0/16 bmt-rede-docker
              else
                echo "Rede bmt-rede-docker j√° existe com o subnet correto."
              fi
            else
              # Se a rede n√£o existir, cria uma nova rede com o subnet correto
              echo "Rede bmt-rede-docker n√£o encontrada. Criando nova rede..."
              sudo docker network create --driver bridge --subnet 172.18.0.0/16 bmt-rede-docker
            fi

            echo "üèÉ Subindo novo container..."
            # Removemos a atribui√ß√£o do IP fixo, deixando o Docker atribuir automaticamente
            sudo docker run -d --name servico-de-login \
              --label project=servico-de-login \
              --network bmt-rede-docker \
              -p 9090:9090 \
              torresbento/bmt-servico-de-login:${{ steps.project_version.outputs.version }}
